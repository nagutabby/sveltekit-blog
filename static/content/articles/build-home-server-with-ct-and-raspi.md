---
title: Cloudflare TunnelとRaspberry Piでお手軽自宅サーバ構築
image: images/Microsoft-Fluentui-Emoji-3d-Fire-3d.1024.png
publishedAt: 2023-09-28T00:00:00.000Z
updatedAt: 2024-05-03T00:00:00.000Z
---

<h1 id="hb19cc5d4d0">Cloudflare Tunnel</h1><p>Cloudflare Tunnelはトンネリングを行うためのサービスです。Cloudflareのエッジサーバと自分のサーバの間にトンネルを作成することで、パブリックIPアドレスを持たないサーバにインターネットから接続できるようになります。</p><h1 id="h1d9b980393">Cloudflare Tunnelを採用した背景</h1><p>自宅にRaspberry Piを余らせており、Cloudflare Tunnelを使ってそれをサーバとして運用できないか？と思い、試しに使ってみたらめちゃくちゃ使いやすかったため採用しました。</p><p>入学した時から大学のISPのネットワークを利用しているのですが、ICMPやSMTPなどのアウトバウンドトラフィックがファイアウォールでブロックされており、自宅サーバを上手く構築できずにいました。Cloudflare Tunnelがいい感じにやってくれると知り、試してみました。</p><h1 id="hb02bfbcce5">Cloudflare Tunnelのいいところ</h1><ul><li>DDNS(Dynamic DNS)や固定パブリックIPアドレスが不要</li><li>CloudflareのCDNの恩恵を受けられる</li><li>SSL証明書を自動で発行してくれる</li><li>IPv6アドレスが割り当てられていないサーバでもIPv6アドレス経由のクライアントと通信できる</li><li>DDoS攻撃の負荷分散を実施してくれる</li><li>ARM環境でもトンネルを構築できる</li></ul><h1 id="h705f30e492">検証環境</h1><ul><li>Rasberry Pi 4 model B</li><li>RAM 4GB</li><li>ROM 32GB</li><li>Ubuntu Server 22.10</li></ul><h1 id="h046876a126">手順</h1><h2 id="hcf6045a5ef">ドメインを取得</h2><p><a href="https://www.cloudflare.com/ja-jp/products/registrar/" target="_blank" rel="noopener noreferrer nofollow"><u>Cloudflare Registrar</u></a>などのレジストラでドメインを取得します。どのドメインを取得すればいいか分からない方は、一番安いTLD(Top Level Domain)のドメインを1つ用意しましょう。</p><h2 id="h991a6aff5b">権威DNSサーバをCloudflareのものに変更</h2><p>Cloudflare TunnelはCloudflareのCDNを利用するため、権威DNSサーバをCloudflareのものに変更する必要があります。</p><p>Cloudflare Registrarで取得した場合は、CloudflareのDNSサーバが初めから権威DNSサーバとして使用されますが、それ以外のレジストラで取得した場合はNSレコードで特定のサブドメインをCloudflareのDNSサーバに委任するか、権威DNSサーバをCloudflareに変更しましょう。</p><h2 id="he4de5bf444">サーバにcloudflaredをインストール</h2><p><a href="https://github.com/cloudflare/cloudflared" target="_blank" rel="noopener noreferrer nofollow"><u>cloudflared</u></a>は、その名の通りcloudflareのデーモン(daemon)で、トンネルを作成するために必要なソフトウェアです。</p><p>Raspberry Piで動作しているUbuntuの場合は、<code>cloudflared-linux-armhf.deb</code>という名前のパッケージをGitHubからwgetし、aptでインストールします。</p><pre><code class="language-bash">wget https://github.com/cloudflare/cloudflared/releases/download/2023.3.0/cloudflared-linux-armhf.deb
sudo apt install -y ./cloudflared-linux-armhf.deb</code></pre><p><code>cloudflared --version</code>を実行してインストールできたかどうか確認します。</p><pre><code class="language-bash">ubuntu@ubuntu:~$ cloudflared --version
cloudflared version 2023.3.0 (built 2023-03-02-1000 UTC)</code></pre><h2 id="hff16bfaf6c">Cloudflareにログイン</h2><p>まずはCloudflareのアカウントでログインする必要があるため、ログイン用のコマンドを実行します。</p><pre><code class="language-bash">cloudflared tunnel login</code></pre><p>認証用URLにアクセスするように求められるので、ブラウザでそのURLにアクセスします。</p><h2 id="h6b14f32c6e">トンネルを作成</h2><p>トンネルの名前は自由に決められます。<code>raspi-tunnel</code>などの名前にするのがいいでしょう。</p><pre><code class="language-bash">cloudflared tunnel create [トンネル名]</code></pre><p>トンネルが作成されると、<code>~/.cloudflared/</code>というディレクトリが作成され、そのディレクトリ以下にトンネリングに必要なファイルが作成されます。</p><h2 id="h71c1c5d444">cloudflaredの設定ファイルを編集</h2><p>cloudflaredの設定ファイルは<code>~/.cloudflared/config.yml</code>と<code>/etc/cloudflared/config.yml</code>です。<code>~/.cloudflared/config.yml</code>を編集してそれを<code>/etc/cloudflared/config.yml</code>にコピーしているので、実質的にファイルに記載する内容は同じです。<code>~/.cloudflared/xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx.json</code>という名前のファイルがクレデンシャルです。</p><p>そのファイルの.jsonまでの部分がトンネルのIDです。これをコピーし、<code>~/.cloudflared/config.yml</code>に記載します。</p><pre><code class="language-yaml">tunnel: xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
credentials-file: /home/[ユーザ名]/.cloudflared/xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx.json

ingress:
 - hostname: www.example.com
   service: http://localhost:80
 - service: http_status:404</code></pre><h2 id="h52bbd904d9">cloudflaredをsystemdのサービスとしてインストール</h2><p>先ほど作成した~/.cloudflared/config.ymlを用いて、cloudflaredのユニットファイルを作成します。</p><pre><code class="language-bash">sudo cloudflared --config ~/.cloudflared/config.yml service install</code></pre><h2 id="he0e6aa55bf">Webサーバをインストール</h2><p>今回はNGINXをインストールします。</p><pre><code class="language-bash">sudo apt install -y nginx</code></pre><h2 id="hbafe050ecc">公開するサービスのゾーン情報を追加</h2><p>CloudflareのDNSにレコードを追加します。</p><pre><code class="language-bash">cloudflared tunnel route dns [トンネル名] [FQDN]</code></pre><p>この記事の例で説明すると、FQDNはwww.example.comになります。</p><h2 id="h1632141dec">Webブラウザで公開先のドメインにアクセス</h2><p>ドメインにアクセスし、公開できていることを確認します。</p><p>今回はlocalhostの80番をトンネリングしているため、HTTP(80/tcp)とHTTPS(443/tcp)からアクセスできます。</p><figure><img src="images/2023-03-18_2015.08.31.png" alt="" width="2992" height="1906"></figure><h1 id="hcb619c5e86">Cloudflare AccessでWebブラウザからSSH通信する</h1><h2 id="h2ab2bf1a9d">Cloudflare Accessのアプリケーションを作成</h2><p>まず初めに<a href="https://www.cloudflare.com/ja-jp/products/zero-trust/access/" target="_blank" rel="noopener noreferrer nofollow"><u>Cloudflare Access</u></a>の設定をします。Cloudflare Accessは、セルフホスト型のアプリやSaaSなどに認証を追加するサービスです。Freeプランで50ユーザまで認証できます。</p><p>Self-hostedを選択し、Cloudflare Accessを利用するドメインを登録します。この記事では、例としてssh.example.comというドメインを使うことにします。ドメインの登録の他には、認証ルールであるPolicyの設定も必要です。参考までに、メールで認証する場合は、設定は以下のようになります。</p><ul><li>Action: Allow</li><li>Rules:<ul><li>Include</li><li>Selector: Emails, あるいはEmails ending in</li><li>Value:<ul><li>Emailsの場合: 認証に使うメールアドレス</li><li>Emails ending inの場合: 認証に使うメールアドレスの@以降<ul><li>例: Gmailのメールアドレスを許可する場合は@gmail.comを入力</li></ul></li></ul></li></ul></li></ul><p>最後に、Additional settingsという項目にあるBrowser renderingをSSHに設定します。</p><h2 id="h97445586a8">/etc/cloudflared/config.ymlにSSHの設定を追加</h2><pre><code class="language-yaml">tunnel: xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
credentials-file: /home/[ユーザ名]/.cloudflared/xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx.json

ingress:
  - hostname: ssh.example.com
    service: ssh://localhost:22
  - hostname: www.example.com
    service: http://localhost:80
  - service: http_status:404</code></pre><h2 id="h4021f99d82">cloudflaredを再起動して/etc/cloudflared/config.ymlの変更を反映させる</h2><pre><code class="language-bash">sudo systemctl restart cloudflared</code></pre><h2 id="hbafe050ecc">公開するサービスのゾーン情報を追加</h2><pre><code class="language-bash">cloudflared tunnel route dns [トンネル名] [FQDN]</code></pre><p>この記事の例で説明すると、FQDNはssh.example.comになります。</p><h2 id="h1632141dec">Webブラウザで公開先のドメインにアクセス</h2><p>HTTPの場合と同様に、Cloudflare Tunnelで関連付けたドメインにアクセスします。</p><p>Cloudflare Accessで認証の設定をしたため、認証画面が表示されます。</p><h1 id="hb50223be1d">トラブルシューティング</h1><h2 id="h2d61a61b13">Cloudflare Tunnelを使ったSSH通信ができない</h2><pre><code>Unable to reach the origin service. The service may be down or it may not be responding to traffic from cloudflared: net/http: HTTP/1.x transport connection broken: malformed HTTP status code</code></pre><p>というエラーが発生する場合は、<code>/etc/cloudflared/config.yml</code>の設定ミスの可能性があります。</p><p>ingressで指定している、<code>service: ssh://localhost:22</code>を<code>service: http://localhost:22</code>とタイポしてしまうと上記のエラーが発生します。</p><p>httpをsshに変更してcloudflaredを再起動すると直ります。</p>
